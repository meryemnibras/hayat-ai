# โ ุญุงูุฉ ุงูููุงู ุงูุญุฑุฌุฉ (Critical Tasks) - Hayat AI Clinic

## ๐ ููุฎุต ุงูุญุงูุฉ

**ุงูุญุงูุฉ ุงูุนุงูุฉ:** โ **ุฌููุน ุงูููุงู ููุชููุฉ ุจุงููุงูู**

---

## 1. โ ุฑุจุท Doctor Model ูุน ุจุงูู ุงููุธุงู

### ุงูุญุงูุฉ: ููุชูู โ

### ูุง ุชู ุฅูุฌุงุฒู:

#### ุฃ. ุชุญุฏูุซ Schema.prisma

**Doctor Model:**
```prisma
model Doctor {
  id                   String        @id @default(cuid())
  clinicId             String?       // โ ุชู ุงูุฅุถุงูุฉ
  clinic               Clinic?       @relation(fields: [clinicId], references: [id])  // โ ุชู ุงูุฅุถุงูุฉ
  fullName             String
  specialization       String
  // ... ุจุงูู ุงูุญููู
  appointments         Appointment[] // โ ุชู ุงูุฅุถุงูุฉ
  // ...
  @@index([clinicId])  // โ ุชู ุงูุฅุถุงูุฉ
}
```

**Appointment Model:**
```prisma
model Appointment {
  id         String            @id @default(cuid())
  // ... existing fields
  doctorId   String?           // โ ุชู ุงูุฅุถุงูุฉ
  doctor     Doctor?           @relation(fields: [doctorId], references: [id])  // โ ุชู ุงูุฅุถุงูุฉ
  // ...
  @@index([doctorId])  // โ ุชู ุงูุฅุถุงูุฉ
}
```

**Clinic Model:**
```prisma
model Clinic {
  id            String         @id @default(cuid())
  // ... existing fields
  doctors       Doctor[]       // โ ุชู ุงูุฅุถุงูุฉ
}
```

#### ุจ. ุชุญุฏูุซ Appointment API

**ุงูููู:** `app/api/appointments/route.ts`

- โ ุฅุถุงูุฉ ุฏุนู `doctorId` ูู GET (query parameter)
- โ ุฅุถุงูุฉ ุฏุนู `doctorId` ูู POST (request body)
- โ ุฅุฑุฌุงุน `doctor` ูู response
- โ Include doctor ูู queries

**ุงูููุฏ:**
```typescript
// GET - Filter by doctorId
if (doctorId) {
  where.doctorId = doctorId;
}

// Include doctor in response
include: {
  doctor: {
    select: {
      id: true,
      fullName: true,
      specialization: true,
      email: true,
      phoneNumber: true,
    },
  },
}
```

### ุงููุชูุฌุฉ:
- โ Doctor ูููู ุฑุจุทู ุจู Clinic
- โ Appointment ูููู ุฑุจุทู ุจู Doctor
- โ API ูุฏุนู doctorId ุจุดูู ูุงูู
- โ ุงูุนูุงูุงุช ุชุนูู ุจุดูู ุตุญูุญ

---

## 2. โ ุฑุจุท HayatAgent Tools ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุงูุญุงูุฉ: ููุชูู โ

### ูุง ุชู ุฅูุฌุงุฒู:

#### ุฃ. ScheduleAppointmentTool โ

**ุงูููู:** `lib/ai/agents/HayatAgent.ts`

**ุงููุธุงุฆู:**
- โ ุฅูุดุงุก Appointment ูุนูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุฑุจุท ูุน Patient ู Doctor ู Clinic
- โ ูุนุงูุฌุฉ ุงูุชูุงุฑูุฎ ูุงูุฃููุงุช
- โ ุฅุฑุฌุงุน ูุนูููุงุช ููุตูุฉ ุนู ุงูููุนุฏ

**ุงูููุฏ ุงูุฑุฆูุณู:**
```typescript
const appointment = await prisma.appointment.create({
  data: {
    clinicId: defaultClinicId,
    patientId: input.patientId,
    doctorId: input.doctorId,
    status: "SCHEDULED",
    source: "CHAT",
    // ...
  },
});
```

#### ุจ. GetPatientInfoTool โ

**ุงููุธุงุฆู:**
- โ ุฌูุจ ุจูุงูุงุช Patient ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุฌูุจ ุขุฎุฑ ุงูููุงุนูุฏ (ุญุชู 5)
- โ ุนุฑุถ ูุนูููุงุช ุดุงููุฉ (ุงูุนูุฑุ ุงูุฌูุณุ ุงููุบุฉุ ุฅูุฎ)
- โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

**ุงูููุฏ ุงูุฑุฆูุณู:**
```typescript
const patient = await prisma.patient.findUnique({
  where: { id: input.patientId },
  include: {
    appointments: {
      take: 5,
      orderBy: { startTime: "desc" },
      include: { doctor: { ... } },
    },
  },
});
```

#### ุฌ. RecommendTreatmentTool โ

**ุงููุธุงุฆู:**
- โ ุงูุจุญุซ ุนู ุฃุทุจุงุก ูุชุฎุตุตูู ุจูุงุกู ุนูู ุงูุงุญุชูุงุฌ
- โ ุฑุจุท ุฐูู ุจูู ุงูุงุญุชูุงุฌุงุช ูุงูุชุฎุตุตุงุช
- โ ุนุฑุถ ุฎุจุฑุฉ ุงูุฃุทุจุงุก ูุชุฎุตุตุงุชูู
- โ ุงูุชุญูู ูู ุงูุนูุงุฌุงุช ุงูุณุงุจูุฉ ูููุฑูุถ
- โ ุชูุฏูู ุชูุตูุงุช ูุฎุตุตุฉ

**ุงูููุฏ ุงูุฑุฆูุณู:**
```typescript
const doctors = await prisma.doctor.findMany({
  where: {
    specialization: {
      in: matchingSpecializations,
    },
  },
  orderBy: { yearsExperience: "desc" },
});
```

#### ุฏ. EscalateToHumanTool โ

**ุงููุธุงุฆู:**
- โ ุฅูุดุงุก Conversation ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุฅูุดุงุก Message ููุชุตุนูุฏ
- โ ุญูุธ metadata (reason, urgency)
- โ ุชุญุฏูุซ Conversation state

**ุงูููุฏ ุงูุฑุฆูุณู:**
```typescript
await prisma.conversation.create({
  data: {
    clinicId: defaultClinicId,
    patientId: input.patientId,
    channel: "CHAT",
    status: "OPEN",
    subject: `ุชุตุนูุฏ: ${input.reason}`,
  },
});

await prisma.message.create({
  data: {
    conversationId: conversation.id,
    senderType: "AI",
    content: `๐จ ุทูุจ ุชุตุนูุฏ...`,
    metadata: { type: "escalation", reason, urgency },
  },
});
```

### ุงููุชูุฌุฉ:
- โ ุฌููุน Tools ูุชุตูุฉ ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุฅูุดุงุก/ูุฑุงุกุฉ/ุชุญุฏูุซ ุงูุจูุงูุงุช ูุนูู ุจุดูู ุตุญูุญ
- โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ููุฌูุฏุฉ
- โ ุฅุฑุฌุงุน ูุนูููุงุช ูููุฏุฉ ูููุณุชุฎุฏู

---

## 3. โ ุฅููุงู Authentication

### ุงูุญุงูุฉ: ููุชูู โ

### ูุง ุชู ุฅูุฌุงุฒู:

#### ุฃ. ุฅุถุงูุฉ ClerkProvider โ

**ุงูููู:** `app/layout.tsx`

```typescript
import { ClerkProvider } from "@clerk/nextjs";

export default function RootLayout({ children }) {
  return (
    <ClerkProvider>
      <html lang="en">
        <body>{children}</body>
      </html>
    </ClerkProvider>
  );
}
```

#### ุจ. ุชุญุฏูุซ Login API โ

**ุงูููู:** `app/api/auth/login/route.ts`

**ุงููุธุงุฆู:**
- โ ุงุณุชุฎุฏุงู Clerk ููุชุญูู ูู ุงููุณุชุฎุฏููู
- โ ูุฒุงููุฉ ุชููุงุฆูุฉ ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุฅูุดุงุก/ุชุญุฏูุซ User ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ Fallback ุฅูู mock response ุฅุฐุง ูู ูุชู ุฅุนุฏุงุฏ Clerk

**ุงูููุฏ ุงูุฑุฆูุณู:**
```typescript
const clerkUsers = await clerkClient.users.getUserList({
  emailAddress: [email],
  limit: 1,
});

const dbUser = await prisma.user.upsert({
  where: { clerkId: clerkUser.id },
  update: { email, fullName },
  create: {
    clerkId: clerkUser.id,
    email,
    fullName,
    clinicId: process.env.DEFAULT_CLINIC_ID || "",
    role: "STAFF",
  },
});
```

#### ุฌ. ุชุญุฏูุซ Register API โ

**ุงูููู:** `app/api/auth/register/route.ts`

**ุงููุธุงุฆู:**
- โ ุฅูุดุงุก ูุณุชุฎุฏู ูู Clerk
- โ ุฅูุดุงุก ูุณุชุฎุฏู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุงูุชุญูู ูู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงูููุฑุฑ
- โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

**ุงูููุฏ ุงูุฑุฆูุณู:**
```typescript
const clerkUser = await clerkClient.users.createUser({
  emailAddress: [email],
  password,
  firstName: fullName.split(" ")[0],
  lastName: fullName.split(" ").slice(1).join(" ") || "",
});

const dbUser = await prisma.user.create({
  data: {
    clerkId: clerkUser.id,
    email,
    fullName,
    phone,
    clinicId: process.env.DEFAULT_CLINIC_ID || "",
    role: "STAFF",
  },
});
```

#### ุฏ. Route Protection โ

**ุงูููู:** `middleware.ts`

**ุงููุธุงุฆู:**
- โ ุฏูุฌ Clerk auth ูุน domain routing
- โ ุญูุงูุฉ ุงููุณุงุฑุงุช ุงูุฎุงุตุฉ
- โ ุชุญุฏูุฏ ุงููุณุงุฑุงุช ุงูุนุงูุฉ
- โ ุงูุญูุงุธ ุนูู domain routing ุงูููุฌูุฏ

**ุงูููุฏ ุงูุฑุฆูุณู:**
```typescript
export default authMiddleware({
  publicRoutes: [
    "/",
    "/pricing",
    "/portal",
    "/portal/login",
    "/portal/register",
    // ...
  ],
  beforeAuth: (req) => {
    return handleDomainRouting(req);
  },
});
```

### ุงููุชูุฌุฉ:
- โ Clerk ูุชูุงูู ุจุงููุงูู
- โ ูุฒุงููุฉ ุชููุงุฆูุฉ ุจูู Clerk ููุงุนุฏุฉ ุงูุจูุงูุงุช
- โ Route protection ูุนูู
- โ Fallback support ููุฌูุฏ

---

## ๐ ูุงุฆูุฉ ุงูุชุญูู ุงูููุงุฆูุฉ

### 1. ุฑุจุท Doctor Model โ
- [x] ุฅุถุงูุฉ clinicId ูู Doctor model
- [x] ุฅุถุงูุฉ doctorId ูู Appointment model
- [x] ุฅุถุงูุฉ relations
- [x] ุฅุถุงูุฉ indexes
- [x] ุชุญุฏูุซ Appointment API
- [x] ุงุฎุชุจุงุฑ ุงูุนูุงูุงุช

### 2. ุฑุจุท HayatAgent Tools โ
- [x] ScheduleAppointmentTool - ูุชุตู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
- [x] GetPatientInfoTool - ูุชุตู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
- [x] RecommendTreatmentTool - ูุชุตู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
- [x] EscalateToHumanTool - ูุชุตู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
- [x] ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ูู ุฌููุน Tools
- [x] ุงุฎุชุจุงุฑ ุฌููุน Tools

### 3. ุฅููุงู Authentication โ
- [x] ุฅุถุงูุฉ ClerkProvider
- [x] ุชุญุฏูุซ Login API
- [x] ุชุญุฏูุซ Register API
- [x] Route Protection
- [x] ูุฒุงููุฉ ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช
- [x] Fallback support

---

## ๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

**ุฌููุน ุงูููุงู ุงูุญุฑุฌุฉ (Critical Tasks) ููุชููุฉ ุจูุณุจุฉ 100%! โ**

- โ ุฑุจุท Doctor Model - ููุชูู
- โ ุฑุจุท HayatAgent Tools - ููุชูู
- โ ุฅููุงู Authentication - ููุชูู

---

**ุชุงุฑูุฎ ุงูุชุญูู:** 2024-12-24
**ุงูุญุงูุฉ:** โ ุฌููุน ุงูููุงู ููุชููุฉ

















